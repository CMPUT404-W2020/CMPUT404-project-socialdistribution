{% load static %}
<!doctype html>
<!DOCTYPE html>
<html>

<head>
    <title>Squawk | Search</title>
    <meta charset="UTF-8">
    <meta name="description" content="Homepage">
    <meta name="author" content="CMPUT404 Group">

    <!-- stylesheets / css -->
    <link rel="stylesheet" href="{% static '../../static/sd/style.css' %}">
    <script type="text/javascript" src="{% static '../../static/sd/helperfunctions.js' %}"></script>
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
</head>

<script type="text/javascript">
    function loadBar() {
        $("#navbar").load("static/sd/navbar.html");
        $("#header").load("static/sd/header.html");
    }

    function makeItAList(val) {
        // Use regex to replace weird characters
        // and anything that isn't strictly the author's name
        val = val.replace(/&lt;/g, '');
        val = val.replace(/&gt;/g, '');
        val = val.replace(/Author: /g, '');

        // It may look like a list, but it's still a string
        val = val.replace(/\[/g, '');
        val = val.replace(/\]/g, '');
        val = val.replace(/, /g, ',');
        val = val.split(',');       // now it's a list

        return val;
    }

    function makeItADict(val) {
        // This function turns a mess of a returned dictionary
        // into a once-again legible dictionary
        val = val.replace(/\[\{/g, '');
        val = val.replace(/\}\]/g, '');
        val = val.replace(/&#x27;/g, '');

        val = val.split('}, {');
        
        ret_val = [];
        for (let v of val) {
            var entry = {};
            v = v.split(', ');
            for (let x of v) {
                x = x.split(': ');
                entry[x[0]] = x[1]
            }
            ret_val.push(entry);
        }

        return ret_val
    }

    function createButtonId(name) {
        return "circle-button-" + name.replace(/ /g, '-') + ""
    }

    function createStatusId(name) {
        return "status-" + name.replace(/ /g, '-') + ""
    }
    
    function search(form) {
        // Get the search value
        var search_val = document.getElementById("search-val");
        var val = search_val.value;

        // Get the authors
        var authors = "{{authors.feed}}";
        authors = makeItAList(authors);

        // Format follow entries
        var follows = "{{follows}}";
        follows = makeItADict(follows);

        // Format friend entries
        var friends = "{{friends}}";
        friends = makeItADict(friends);
        console.log("Friends: ", friends);

        
        // filter authors for matching results
        var results = [];
        authors = authors.sort();
        for (let a of authors) {
            if (a.toUpperCase().includes(val.toUpperCase())) {
                var entry = {};
                entry['name'] = a;
                // Are we friends?
                for (let f of friends) {
                    if (f['name'] == a) {
                        entry['status'] = 'Friends';
                        entry['icon'] = '-';
                        entry['action'] = `"removeFriend('${f['uuid']}', '${f['name']}')"`
                    }
                }

                if (!entry['status']) {
                    // We're not friends :'(
                    for (let f of follows) {
                        if (f['following'] == a) {
                            entry['status'] = 'Following';
                            entry['icon'] = '-';
                            entry['action'] = `"unfollow('${f['following_uuid']}', '${f['following']}')"`
                            break;
                        } else if (f['follower'] == a) {
                            entry['status'] = 'Follows you'
                            entry['icon'] = '+';
                            break;
                        }
                    }
                }

                if (!entry['status']) { entry['status'] = ""; }
                if (!entry['icon']) { entry['icon'] = "+" }

                if (entry['icon'].valueOf() === '+') {
                    entry['action'] = `"sendRequest('${a}')"`;
                }
                
                results.push(entry);
            }
        }

        displayResults(results);
    }

    function displayResults(results) {

        // add the new div for the results
        if (!document.getElementById("search-results")) {
            document.getElementById("search").innerHTML += `<div class="search-results" id="search-results">
            </div>`
        }

        var display = document.getElementById("search-results");
        display.innerHTML = "";
        if (results.length == 0) {
            display.innerHTML = `<span id="centered">
                <!-- This file is licensed under the Creative Commons Attribution-Share Alike 3.0 Unported license. https://thenounproject.com/term/question/1101884/ Author: AliWijaya -->
                <img class="noresults-img" src="static/sd/icons/questionmark.svg" alt="No Results" height="300em"
                    float="centre">
                <br>
                <h4> No Search Results </h4>
            </span>`
        } else {
            display.innerHTML += results.length.toString() + " search results";
            for (let a of results) {
                var btn_id = createButtonId(a['name']);
                var status_id = createStatusId(a['name']);
                display.innerHTML += `<div>
                        <hr class="greyline">
                        <span class="searchauthor">${a['name']}</span>
                        <span class="dot"></span>
                        <span class="searchrelation" id="${status_id}"> ${a['status']} </span>
                        <button id="${btn_id}" onclick=${a['action']}>${a['icon']}</button>
                    </div>`;
            }
        }

    }

    function updateInnerHTML(name, status) {
        // This function is not currently used 'cause it's hard to change the 
        // onclick attribute of a button. However, this function does successfully 
        // change the status message and button icon when the button is pressed.
        // I'm thinking a simple page reload might be easier though

        // name is the author upon which to perform the action
        // status is the action to be performed

        var btn_id = createButtonId(name);
        var status_id = createStatusId(name);

        if (status == 'follow') {
            document.getElementById(btn_id).innerText = '-';

            var status = document.getElementById(status_id).innerText;
            if (status.toUpperCase() == 'FOLLOWS YOU') {
                document.getElementById(status_id).innerText = 'Friends';
                // new action: unfriend
                // need uuid for this
                document.getElementById(btn_id).innerText = () => {};
            } else {
                document.getElementById(status_id).innerText = 'Following';
                // new action: unfollow
                // need uuid for this
                document.getElementById(btn_id).innerText = () => {};
            }
        }

        if (status == 'unfriend') {
            document.getElementById(btn_id).innerText = '+';
            document.getElementById(status_id).innerText = 'Follows You';
            // new action: friend
            // only need the name to send a friend request!
            document.getElementById(btn_id).setAttribute('onclick', `"sendRequest('${author}')"`);
        }

        if (status == 'unfollow') {
            document.getElementById(btn_id).innerText = '+';
            document.getElementById(status_id).innerText = '';
            // new action: follow
            // only need a name to send a follow!
            document.getElementById(btn_id).setAttribute('onclick', `"sendRequest('${author}')"`);
        }

    }

    function sendRequest(author) {
        console.log("Author:", author);
        console.log("Current user: ", "{{current_user}}");

        const data = {
            "current_user": "{{current_user}}",
            "target_author": author
        };

        fetch('http://127.0.0.1:8000/friendrequest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
        .then(function(response) {
            return response.text();
        }).then(function(data){
            alert(`Friend request successfully sent to ${author}.\nYou are now following ${author}.`);
        }).catch(function(data) {
            alert("Friend request could not be sent at this time.\nPlease try again later.");
        });
    }

    function removeFriend(uuid, author) {
        var yes = confirm("Would you like to remove this friend?\nThis author can still follow your posts even if you remove them as a friend.");

        if (yes) {
            fetch('http://127.0.0.1:8000/remove_friend/' + uuid, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
            })
            .then(function(response) {
                return response.text();
            }).then(function(data){
                alert(`You have successfully removed ${author} as a friend.\n${author} can still see your public posts.`);
            }).catch(function(data) {
                alert("This friend could not be removed at this time.\nPlease try again later.");
            });
        }
    }

    function unfollow(uuid, author) {
        var yes = confirm("Would you like to unfollow this author?");

        if (yes) {
            fetch('http://127.0.0.1:8000/remove_follow/' + uuid, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
            })
            .then(function(response) {
                return response.text();
            }).then(function(data){
                alert(`You have successfully unfollowed ${author}.`);
            }).catch(function(data) {
                alert("This author could not be unfollowed at this time.\nPlease try again later.");
            });
        }
    }


</script>

<body onload="loadBar()">
    <div class="header" id="header">
    </div>

    <div class="row" id="search">
        <div class="navbar" id="navbar">
        </div>

        <div class="search-bar">
            <!-- referencing: https://stackoverflow.com/questions/10520899/form-action-with-javascript/34467977 -->
            <form action="javascript:;" onsubmit="search(this)">
                <label for="search-val">Enter search term: </label>
                <input type="text" placeholder="Search..." name="search-val" id="search-val">
            </form>
            <br>

        </div>

    </div>
    </div>
</body>

</html>